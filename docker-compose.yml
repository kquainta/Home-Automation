services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    volumes:
      - ./backend:/app
      # Mount .env so the backend can read it (avoids env substitution issues)
      - ./.env:/app/.env.mounted:ro
      # Mount Home Assistant media share
      # Docker Desktop on Windows can't mount UNC paths or mapped drives directly
      # Solution: Copy house*.jpg files to ./local-ha-media folder and mount that
      - "${PWD}/local-ha-media:/mnt/ha-media:ro"
    ports:
      - "8000:8000"
    environment:
      - MQTT_BROKER=mqtt-broker
      - ENV_FILE_PATH=/app/.env.mounted
      # Seed users: Compose reads project root .env and passes these into the container
      - E2E_SEED_EMAIL=${E2E_SEED_EMAIL:-}
      - E2E_SEED_PASSWORD=${E2E_SEED_PASSWORD:-}
      - ADMIN_SEED_EMAIL=${ADMIN_SEED_EMAIL:-}
      - ADMIN_SEED_PASSWORD=${ADMIN_SEED_PASSWORD:-}
      - E2E_SEED_USER=${E2E_SEED_USER:-}
      # Do NOT pass HOME_ASSISTANT_* here: empty env vars would override the mounted .env file.
      # Backend reads them from the mounted .env at /app/.env.mounted only.
    depends_on:
      - mqtt-broker

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8000/api/v1

  mqtt-broker:
    image: eclipse-mosquitto:latest
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - mosquitto-conf:/mosquitto/config
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log

volumes:
  mosquitto-conf:
  mosquitto-data:
  mosquitto-log:
