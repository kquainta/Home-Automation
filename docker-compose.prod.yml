# Production compose for GCP VM (or any host).
# No dev volumes; frontend is built with VITE_API_URL pointing at your backend.
#
# Usage:
#   export VITE_API_URL=http://YOUR_VM_IP:8000/api/v1
#   docker compose -f docker-compose.prod.yml build --build-arg VITE_API_URL=$VITE_API_URL
#   docker compose -f docker-compose.prod.yml up -d

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - MQTT_BROKER=mqtt-broker
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-in-production}
    depends_on:
      - mqtt-broker
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000/api/v1}
        VITE_BUILD_TIME: ${VITE_BUILD_TIME:-}
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

  mqtt-broker:
    image: eclipse-mosquitto:latest
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - mosquitto-conf:/mosquitto/config
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
    restart: unless-stopped

volumes:
  mosquitto-conf:
  mosquitto-data:
  mosquitto-log:
